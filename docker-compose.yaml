version: '3.8'

services:
  # The Node.js Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dsi_backend_dev
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      MONGO_URI: "mongodb+srv://akmalali:Akmal@cluster0.5whc0.mongodb.net/?appName=Cluster0"
      JWT_SECRET: "a_very_strong_and_long_secret_key_for_jwt"
      CLOUDINARY_CLOUD_NAME: "ddkz28ci4"
      CLOUDINARY_API_KEY: "245447926624591"
      CLOUDINARY_API_SECRET: "uQIxjsyHTjonU-d4b64QzvCtuEg"
      ML_API_ENDPOINT: "http://ml-api:5002/ml/analyze-drawing"
    volumes:
      # Mount the entire backend directory into the container
      # Any change you make locally will be reflected inside
      - ./backend:/usr/src/app
      # Anonymous volume to keep node_modules separate
      - /usr/src/app/node_modules
    networks:
      - dsi-network

  # The Python ML API Service
  ml-api:
    build:
      context: ./ml-api
      dockerfile: Dockerfile
    container_name: dsi_ml_api_dev
    restart: unless-stopped
    ports:
      - "5002:5002"
    env_file:
      - ./ml-api/.env
    volumes:
      # Mount the ML API source code
      - ./ml-api:/app
      # Mount your local Conda environment's packages
      - /home/akmal-ali/miniconda3/envs/smai/lib/python3.13/site-packages:/usr/local/lib/python3.13/site-packages
    networks:
      - dsi-network

  # The React Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: dsi_frontend_dev
    restart: unless-stopped
    ports:
      - "3000:3000" # React dev server runs on 3000
    volumes:
      # Mount the frontend source code
      - ./frontend:/app
      # Anonymous volume for node_modules
      - /app/node_modules
    networks:
      - dsi-network

networks:
  dsi-network:
    driver: bridge